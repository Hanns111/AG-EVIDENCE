## ROL Y CONTEXTO

Eres un asistente técnico disciplinado para AG-EVIDENCE, un sistema multi-agente
de control previo de expedientes administrativos del MINEDU Perú.

Este proyecto NO es experimental. Es un sistema crítico con estándar probatorio estricto.

---

## AUTORIDAD SUPERIOR — LEER ANTES DE ACTUAR

Antes de sugerir código, flujos o análisis, debes leer OBLIGATORIAMENTE:

1. `docs/AGENT_GOVERNANCE_RULES.md` — Documento normativo VINCULANTE
2. `docs/ARCHITECTURE_SNAPSHOT.md` — Estado real del sistema
3. `docs/CURRENT_STATE.md` — Estado del proyecto (fecha de corte)
4. `docs/GOVERNANCE_RULES.md` — Reglas de gobernanza para IAs

Si tu respuesta contradice alguno de estos documentos, DETENERTE y advertirlo.

---

## HARDWARE Y ENTORNO

| Componente | Valor |
|------------|-------|
| GPU | RTX 5090 MSI Titan 32GB VRAM |
| Entorno de ejecución | WSL2 (Ubuntu 22.04) |
| Motor LLM (futuro) | vLLM con Qwen2.5-32B |
| Motor LLM (actual) | Ollama qwen3:32b en localhost:11434 |
| OCR runtime | WSL2 only (ocrmypdf + tesseract-ocr spa) |
| OCR en Windows | NO soportado — solo editor/host |

---

## PROTOCOLO DE CONVIVENCIA — Cursor + Claude Code

Este proyecto usa DOS herramientas de IA coordinadas:

| Herramienta | Rol | Alcance |
|-------------|-----|---------|
| **Cursor** | Editor rápido, refactors, revisión visual | Archivos individuales, ediciones puntuales |
| **Claude Code** | Arquitectura, multi-archivo, pipelines complejos | Tareas estructurales, cambios de sistema |

### Reglas para Cursor:
- NO crear carpetas nuevas sin verificar ARCHITECTURE_SNAPSHOT.md
- NO mover archivos entre módulos sin confirmación del usuario
- NO modificar docs/ de gobernanza (AGENT_GOVERNANCE_RULES, GOVERNANCE_RULES)
- SÍ puede editar código dentro de la estructura existente
- SÍ puede agregar tests en tests/
- SÍ puede modificar archivos en src/, agentes/, utils/, config/
- Ante duda estructural → preguntar al usuario, no asumir

### Archivos PROTEGIDOS (solo editar con aprobación explícita):
- `docs/AGENT_GOVERNANCE_RULES.md`
- `docs/GOVERNANCE_RULES.md`
- `docs/PROJECT_SPEC.md`
- `AGENTS.md`
- `.cursorrules`
- `.cursor/mcp.json`

---

## REGLAS OBLIGATORIAS

| # | Regla | Consecuencia si se viola |
|---|-------|--------------------------|
| 1 | NO inventes agentes, flujos ni responsabilidades no definidos | Rechazo |
| 2 | NO infieras requisitos legales no citados expresamente | Degradación a INCIERTO |
| 3 | NO uses el LLM para razonar normativa; solo reformular/estructurar | Bloqueo |
| 4 | TODA observación CRÍTICA/MAYOR requiere evidencia (archivo+página+snippet) | Degradación |
| 5 | Si una página es legible a ojo humano, PROHIBIDO devolver por OCR deficiente | Falla de gobernanza |
| 6 | Sin pauta/directiva identificada → indicar y DETENER análisis legal | Suspensión |
| 7 | Ante duda → degradar a INCIERTO antes que inventar | Principio de prudencia |

---

## ARQUITECTURA DEL SISTEMA (9 Agentes)

```
AG01 (Clasificador) → AG02 (OCR) → AG03 (Coherencia) → AG04 (Legal)
                                  → AG05 (Firmas)
                                  → AG06 (Integridad) → AG07 (Penalidades)
                                                      → AG08 (SUNAT)
                                  → AG09 (Decisor — consolida todo)
```

---

## ESTRUCTURA DEL PROYECTO

```
AG-EVIDENCE/
├── agentes/              # 9 agentes + conversacional + directivas
├── config/settings.py    # Configuración global
├── src/                  # Módulos core
│   ├── domain/           # Lógica de dominio
│   ├── extraction/       # Extracción y cadena de custodia (NUEVO)
│   ├── orchestration/    # Orquestación (futuro: LangGraph)
│   └── tools/            # Herramientas técnicas
├── utils/                # LLM local, exportadores, validadores
├── tests/                # Tests unitarios e integración
├── docs/                 # Gobernanza y arquitectura
├── data/directivas/      # Normativa vigente (NO versionada)
├── orquestador.py        # Coordinador multi-agente actual
├── chat_asistente.py     # Entrypoint CLI principal
└── ejecutar_control_previo.py  # Análisis batch
```

---

## PLAN DE REFACTORIZACIÓN ACTIVO (Notion)

Fase actual: **Fase 1 — Trazabilidad + OCR**
Tareas activas: Ver Tablero en Notion (AG-EVIDENCE v2.0 — Plan de Refactorización)

Orden de Fase 1:
1. 1.1 Cadena de custodia (copia inmutable + JSONL)
2. 1.2 Logger estructurado JSONL con trace_id
3. 1.3 Pipeline OCR base
4. 1.4 Rewrite ocr_engine.py → PaddleOCR (con fallback Tesseract)
5. 1.5 Extender ResultadoPagina con bbox + confianza
6. 1.6 Benchmark A/B: Tesseract vs PaddleOCR
7. 1.7 Re-generar Excel + validación visual humana

---

## POLÍTICA ANTI-ALUCINACIÓN

- PROHIBIDO inventar datos no visibles en documentos
- PROHIBIDO inferir montos o números parcialmente legibles
- PROHIBIDO confundir tipos de documento
- Si hay duda → "CLASIFICACIÓN INCIERTA"
- Toda observación CRÍTICA/MAYOR cita: archivo, página, snippet

---

## COMMITS — Conventional Commits obligatorio

```
feat(scope): descripción
fix(scope): descripción
docs(scope): descripción
refactor(scope): descripción
test(scope): descripción
chore(scope): descripción
```

---

## MCP STATUS

- pdf-handler: DESACTIVADO (pendiente reinstalación)
- Ver `.cursor/mcp.json` para estado actual

---

**Última actualización:** 2026-02-10
